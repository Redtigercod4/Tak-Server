"use strict";(self.webpackChunkdocusaurus_static=self.webpackChunkdocusaurus_static||[]).push([[5582],{4446:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>o,contentTitle:()=>i,default:()=>h,frontMatter:()=>s,metadata:()=>c,toc:()=>d});var t=n(5893),a=n(1151);const s={},i="Building and Installing Container Images Using Docker",c={id:"dockerinstall/buildinstall",title:"Building and Installing Container Images Using Docker",description:"TAK Server can be installed using docker. Start by downloading container images from tak.gov. You will need the docker release which comes as a zip file called 'takserver-docker-\\.zip'.",source:"@site/docs/dockerinstall/buildinstall.md",sourceDirName:"dockerinstall",slug:"/dockerinstall/buildinstall",permalink:"/docs/dockerinstall/buildinstall",draft:!1,unlisted:!1,editUrl:"https://gitlab.com/octospacc/editocttrialTools/-/blob/main/docusaurus-static/docs/dockerinstall/buildinstall.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"IronBank",permalink:"/docs/dockerinstall/ironbank"},next:{title:"Overview",permalink:"/docs/firewall/overview"}},o={},d=[];function l(e){const r={a:"a",code:"code",em:"em",h1:"h1",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.a)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(r.h1,{id:"building-and-installing-container-images-using-docker",children:"Building and Installing Container Images Using Docker"}),"\n",(0,t.jsx)(r.p,{children:"TAK Server can be installed using docker. Start by downloading container images from tak.gov. You will need the docker release which comes as a zip file called 'takserver-docker-<version>.zip'."}),"\n",(0,t.jsxs)(r.p,{children:["If you using CentOS 7, follow these instructions first to install docker, start the docker daemon and use it as a regular user:\n",(0,t.jsx)(r.a,{href:"https://www.digitalocean.com/community/tutorials/how-to-install-and-use-docker-on-centos-7",children:"https://www.digitalocean.com/community/tutorials/how-to-install-and-use-docker-on-centos-7"})]}),"\n",(0,t.jsxs)(r.p,{children:["Next, unzip the docker zip file. ",(0,t.jsx)(r.strong,{children:"All further commands should be run from this top level 'takserver-docker-<version>' directory."})," If you are familiar with the rpm install, the 'tak' folder within the 'takserver-docker-<version>' directory represents the '/opt/tak' directory installed by the rpm. When the takserver containers are built, the 'tak' directory will be mounted to '/opt/tak' within the containers. Therefore, any references to '/opt/tak' outside this section of the guide will be equivalent to the 'tak' directory you have on the host, or '/opt/tak' if you are working from inside the container. The 'tak' directory is where the coreconfig, certificates, logs and other TAK configuration/tools will live. This folder is shared between the host, the takserver container and the takserver database container. This means you can tail the logs or manually edit the coreconfig from the host without being inside the container."]}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:"Notes for running in Windows Subsystem for Linux (WSL) 2:"})}),"\n",(0,t.jsxs)(r.p,{children:["When running TAK Server in the WSL2 environment, follow the steps outlined in the Best Practices section here ",(0,t.jsx)(r.a,{href:"https://docs.docker.com/desktop/windows/wsl/",children:"https://docs.docker.com/desktop/windows/wsl/"})," to maximize TAK Server performance. Specifically, it\u2019s recommended that you copy the 'takserver-docker-<version>.zip' file into your WSL user\u2019s home directory and execute all docker commands from there (vs accessing your Windows filesystem from /mnt). From there, unzip the file and run the docker commands below for TAK Server. It\u2019s important to unzip the file from within WSL to ensure permissions are setup correctly."]}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:"TAK Server CoreConfig Setup:"})}),"\n",(0,t.jsxs)(r.ol,{children:["\n",(0,t.jsx)(r.li,{children:"Open tak/CoreConfig.example.xml and set a database password"}),"\n",(0,t.jsx)(r.li,{children:"Make any other configuration changes you need"}),"\n"]}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:"TAK Server Database Container Setup:"})}),"\n",(0,t.jsxs)(r.ol,{children:["\n",(0,t.jsx)(r.li,{children:"Build TAK server database image:"}),"\n"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:'docker build -t takserver-db:"$(cat tak/version.txt)" -f docker/Dockerfile.takserver-db .\n'})}),"\n",(0,t.jsxs)(r.ol,{start:"2",children:["\n",(0,t.jsx)(r.li,{children:"Create a new docker network for the current tak version:"}),"\n"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:'docker network create takserver-"$(cat tak/version.txt)"\n'})}),"\n",(0,t.jsxs)(r.ol,{start:"3",children:["\n",(0,t.jsx)(r.li,{children:"The TAK Server database container can be configured to persist data directly to the host or only within the container."}),"\n"]}),"\n",(0,t.jsx)(r.p,{children:"a. To persist to the host, create an empty host directory (unless you have a directory from a    previous docker install you want to reuse). For upgrading purposes, we recommend that you\tkeep the takserver database directory outside of the 'takserver-docker-<version>' directory\tstructure."}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:'docker run -d -v <absolute path to takserver database directory>:/var/lib/postgresql/data:z -v $(pwd)/tak:/opt/tak:z -it -p 5432:5432 --network takserver-"$(cat tak/version.txt)" --network-alias tak-database --name takserver-db-"$(cat tak/version.txt)" takserver-db:"$(cat tak/version.txt)"\n'})}),"\n",(0,t.jsx)(r.p,{children:"b. To run TAK server database with container only persistence"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:'docker run -d -v $(pwd)/tak:/opt/tak:z -it -p 5432:5432 --network takserver-"$(cat tak/version.txt)" --network-alias tak-database --name takserver-db-"$(cat tak/version.txt)" takserver-db:"$(cat tak/version.txt)"\n'})}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:"TAK Server Container Setup:"})}),"\n",(0,t.jsxs)(r.ol,{children:["\n",(0,t.jsx)(r.li,{children:"Build TAK Server image:"}),"\n"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:'docker build -t takserver:"$(cat tak/version.txt)" -f docker/Dockerfile.takserver .\n'})}),"\n",(0,t.jsxs)(r.ol,{start:"2",children:["\n",(0,t.jsxs)(r.li,{children:["Running TAK Server container: use -p <host port>:<container port> to map any additional ports you have configured. ",(0,t.jsx)(r.strong,{children:"Adding new inputs or changing ports while the container is running will require the container to be recreated so that the new port mapping can be added."})]}),"\n"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:'docker run -d -v $(pwd)/tak:/opt/tak:z -it -p 8089:8089 -p 8443:8443 -p 8444:8444 -p 8446:8446 -p 9000:9000 -p 9001:9001 --network takserver-"$(cat tak/version.txt)" --name takserver-"$(cat tak/version.txt)" takserver:"$(cat tak/version.txt)"\n'})}),"\n",(0,t.jsxs)(r.ol,{start:"3",children:["\n",(0,t.jsxs)(r.li,{children:["\n",(0,t.jsxs)(r.p,{children:[(0,t.jsx)(r.strong,{children:"Before using the TAK Server, you must setup the certificates for secure operation."})," If you have already configured certificates you can skip this step. You can also copy existing certificates into 'tak/certs/files' and a UserAuthetication.xml file into 'tak/' to reuse existing certificate authentication settings. ",(0,t.jsx)(r.strong,{children:"Any change to certificates while the container is running will require either a TAK server restart or container restart."})," Additional certificate details can be found in Appendix B."]}),"\n",(0,t.jsx)(r.p,{children:"a. Edit tak/certs/cert-metadata.sh"}),"\n",(0,t.jsx)(r.p,{children:"b. Generate root ca"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:'docker exec -it takserver-"$(cat tak/version.txt)" bash -c "cd /opt/tak/certs && ./makeRootCa.sh"\n'})}),"\n",(0,t.jsx)(r.p,{children:"c. Generate server cert"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:'docker exec -it takserver-"$(cat tak/version.txt)" bash -c "cd /opt/tak/certs && ./makeCert.sh server takserver"\n'})}),"\n",(0,t.jsx)(r.p,{children:"d. Create client cert(s)"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:'docker exec -it takserver-"$(cat tak/version.txt)" bash -c "cd /opt/tak/certs && ./makeCert.sh client <user>"\n'})}),"\n",(0,t.jsx)(r.p,{children:"e. Restart takserver to load new certificates"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:'docker exec -d takserver-"$(cat tak/version.txt)" bash -c "cd /opt/tak/ && ./configureInDocker.sh"\n'})}),"\n",(0,t.jsxs)(r.p,{children:["f. Tail takserver logs from the host. ",(0,t.jsx)(r.strong,{children:"Once TAK server has successfully started, proceed to the next step."})]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:"tail -f tak/logs/takserver-messaging.log\ntail -f tak/logs/takserver-api.log\n"})}),"\n"]}),"\n",(0,t.jsxs)(r.li,{children:["\n",(0,t.jsx)(r.p,{children:"Accessing takserver\nCreate admin client certificate for access on secure port 8443 (https):"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:'docker exec takserver-"$(cat tak/version.txt)" bash -c  "cd /opt/tak/ && java -jar utils/UserManager.jar certmod -A certs/files/<client cert>.pem"\n'})}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:"Hardened TAK Server Setup:"})}),"\n",(0,t.jsx)(r.p,{children:"The hardened TAK Database and Server containers provide additional security by including the use of secure Iron Bank base images, container health checks, and minimizing user privileges within the containers."}),"\n",(0,t.jsx)(r.p,{children:"The hardened TAK images are available in a zip file, takserver-docker-hardened-<version>.zip. The steps for setting up the hardened containers are similar to the standard docker installation steps given above except for the following:"}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:"Certificate Generation:"})}),"\n",(0,t.jsx)(r.p,{children:"The certificate generation container is only required to run once for TAK Server initialization. Run all commands in this section from the root of the unzipped hardened docker contents."}),"\n",(0,t.jsxs)(r.ol,{children:["\n",(0,t.jsx)(r.li,{children:"Build the Certificate Authority Setup Image:"}),"\n"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:"docker build -t ca-setup-hardened --build-arg ARG_CA_NAME=<CA_NAME> --build-arg ARG_STATE=<ST> --build-arg ARG_CITY=<CITY> --build-arg ARG_ORGANIZATIONAL_UNIT=<UNIT> -f docker/Dockerfile.ca .\n"})}),"\n",(0,t.jsxs)(r.ol,{start:"2",children:["\n",(0,t.jsx)(r.li,{children:"Run the Certificate Authority Setup Container: If certificates have previously been generated and exist in the tak/cert/files path when building the ca-setup-hardened image then certificate generation will be skipped at runtime."}),"\n"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:"docker run --name ca-setup-hardened -it -d ca-setup-hardened\n"})}),"\n",(0,t.jsxs)(r.ol,{start:"3",children:["\n",(0,t.jsx)(r.li,{children:"Copy the generated certificates for TAK Server:"}),"\n"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:"docker cp ca-setup-hardened:/tak/certs/files files\n\n[ -d tak/certs/files ] || mkdir tak/certs/files \\\n&& docker cp ca-setup-hardened:/tak/certs/files/takserver.jks tak/certs/files/ \\\n&& docker cp ca-setup-hardened:/tak/certs/files/truststore-root.jks tak/certs/files/ \\\n&& docker cp ca-setup-hardened:/tak/certs/files/fed-truststore.jks tak/certs/files/ \\\n&& docker cp ca-setup-hardened:/tak/certs/files/admin.pem tak/certs/files/ \\\n&& docker cp ca-setup-hardened:/tak/certs/files/config-takserver.cfg tak/certs/files/\n"})}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:"TAK Server Database Hardened Container Setup:"})}),"\n",(0,t.jsxs)(r.ol,{children:["\n",(0,t.jsx)(r.li,{children:"Building the hardened docker images requires creating an Iron Bank/Repo1 account to access the approved base images. To create an account, follow the instructions in the IronBank Getting Started page. To download the base images via the CLI, see the instructions in the Registry Access section. After obtaining the necessary credentials, run:"}),"\n"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:"docker login registry1.dso.mil\n"})}),"\n",(0,t.jsxs)(r.ol,{start:"2",children:["\n",(0,t.jsx)(r.li,{children:"Follow the instructions in the TAK Server CoreConfig Setup section and update the <connection-url> tag with the hardened TAK Database container name. For example:"}),"\n"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:'connection url="jdbc:postgresql://tak-database-hardened-<version>:5432/cot" username="martiuser" password=<password>/>\n'})}),"\n",(0,t.jsxs)(r.ol,{start:"3",children:["\n",(0,t.jsx)(r.li,{children:"Create a new docker network for the current tak version:"}),"\n"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:'docker network create takserver-net-hardened-"$(cat tak/version.txt)"\n'})}),"\n",(0,t.jsx)(r.p,{children:"Ensure in the db-utils/pg_hba.conf file that there is an entry for the subnet of the hardened takserver network. To determine the subnet of the network:"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:'docker network inspect takserver-net-hardened-"$(cat tak/version.txt)"\n'})}),"\n",(0,t.jsx)(r.p,{children:"Or to specify the subnet on network creation:"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:'docker network create takserver-net-hardened-"$(cat tak/version.txt)" --subnet=<subnet>\n'})}),"\n",(0,t.jsxs)(r.ol,{start:"4",children:["\n",(0,t.jsx)(r.li,{children:"Build the hardened TAK Database image:"}),"\n"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:'docker build -t tak-database-hardened:"$(cat tak/version.txt)" -f docker/Dockerfile.hardened-takserver-db .\n'})}),"\n",(0,t.jsxs)(r.ol,{start:"5",children:["\n",(0,t.jsx)(r.li,{children:"Run the hardened TAK Database container:"}),"\n"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:'docker run --name tak-database-hardened-"$(cat tak/version.txt)" --network takserver-net-hardened-"$(cat tak/version.txt)" --network-alias tak-database -d tak-database-hardened:"$(cat tak/version.txt)" -p 5432:5432\n'})}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:"TAK Server Hardened Container Setup"})}),"\n",(0,t.jsxs)(r.ol,{children:["\n",(0,t.jsx)(r.li,{children:"Build the hardened TAK Server image:"}),"\n"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:'docker build -t takserver-hardened:"$(cat tak/version.txt)" -f docker/Dockerfile.hardened-takserver .\n'})}),"\n",(0,t.jsxs)(r.ol,{start:"2",children:["\n",(0,t.jsx)(r.li,{children:"Run the hardened TAK Server container:"}),"\n"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:'docker run --name takserver-hardened-"$(cat tak/version.txt)" --network takserver-net-hardened-"$(cat tak/version.txt)" -p 8089:8089 -p 8443:8443 -p 8444:8444 -p 8446:8446 -t -d takserver-hardened:"$(cat tak/version.txt)"\n'})}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:"Configuring Certificates"})}),"\n",(0,t.jsxs)(r.ol,{children:["\n",(0,t.jsx)(r.li,{children:"Get the admin certificate fingerprint"}),"\n"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:"docker exec -it ca-setup-hardened bash -c \"openssl x509 -noout -fingerprint -md5 -inform pem -in files/admin.pem | grep -oP 'MD5 Fingerprint=\\K.*'\"\n"})}),"\n",(0,t.jsxs)(r.ol,{start:"2",children:["\n",(0,t.jsx)(r.li,{children:"Add the certificate fingerprint as the admin after the hardened TAK server container has started (about 60 seconds)"}),"\n"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:"docker exec -it takserver-hardened-\"$(cat tak/version.txt)\" bash -c 'java -jar /opt/tak/utils/UserManager.jar usermod -A -f <admin cert fingerprint> admin'\n"})}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.strong,{children:"Useful Commands"})}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.em,{children:"To run these commands on the hardened containers, add the -hardened suffix to the container names."})}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsx)(r.li,{children:"View images:"}),"\n"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:"docker images takserver\ndocker images takserver-db\n"})}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsx)(r.li,{children:"View containers\nAll: 'docker ps -a'\nRunning: 'docker ps'\nStopped: 'docker ps -a | grep Exit'"}),"\n",(0,t.jsx)(r.li,{children:"Exec into container"}),"\n"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:'docker exec -it takserver-"$(cat tak/version.txt)" bash\ndocker exec -it takserver-db-"$(cat tak/version.txt)" bash\n'})}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsx)(r.li,{children:"Exec command in container"}),"\n"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:'docker exec -it takserver-"$(cat tak/version.txt)" bash -c  "<command>"\ndocker exec -it takserver-db-"$(cat tak/version.txt)" bash -c  "<command>"\n'})}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsx)(r.li,{children:"Tail takserver logs"}),"\n"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:"tail -f tak/logs/takserver-messaging.log\ntail -f tak/logs/takserver-api.log\n"})}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsx)(r.li,{children:"Restart  TAK server"}),"\n"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:'docker exec -d takserver-"$(cat tak/version.txt)" bash -c "cd /opt/tak/ && ./configureInDocker.sh"\n'})}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsx)(r.li,{children:"Start/Stop container:"}),"\n"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:'docker <start/stop> takserver-"$(cat tak/version.txt)"\ndocker <start/stop> takserver-db-"$(cat tak/version.txt)"\n'})}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsx)(r.li,{children:"Remove container:"}),"\n"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:'docker rm -f takserver-"$(cat tak/version.txt)"\ndocker rm -f takserver-db-"$(cat tak/version.txt)"\n'})})]})}function h(e={}){const{wrapper:r}={...(0,a.a)(),...e.components};return r?(0,t.jsx)(r,{...e,children:(0,t.jsx)(l,{...e})}):l(e)}},1151:(e,r,n)=>{n.d(r,{Z:()=>c,a:()=>i});var t=n(7294);const a={},s=t.createContext(a);function i(e){const r=t.useContext(s);return t.useMemo((function(){return"function"==typeof e?e(r):{...r,...e}}),[r,e])}function c(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:i(e.components),t.createElement(s.Provider,{value:r},e.children)}}}]);